<!DOCTYPE html>
<html lang="zh-cn">
    <head>
    <meta http-equiv="content-type" content="text/html;charset=utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noodp"/>
    <meta name="author" content="pengganyu">
    <meta name="description" content="Peng ganyu的个人博客">
    
    
    
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        <meta name="referrer" content="no-referrer-when-downgrade"><link rel="prev" href="https://xibolun.github.io/post/etcd/etcd%E5%85%A5%E9%97%A8/" />
    <link rel="next" href="https://xibolun.github.io/post/etcd/etcd%E4%BB%8E%E6%BA%90%E7%A0%81%E7%9C%8B%E6%97%A5%E5%BF%97%E5%A4%8D%E5%88%B6/" />
    <link rel="canonical" href="https://xibolun.github.io/post/etcd/etcd%E4%BB%8E%E6%BA%90%E7%A0%81%E7%9C%8Braft%E9%80%89%E4%B8%BE/" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">
    <title>
        
        
            etcd––从源码看raft选举 | Peng ganyu blog
        
    </title>
    <meta name="title" content="etcd––从源码看raft选举 | Peng ganyu blog">
    
<link rel="stylesheet" href="/css/main.min.css">


    
    
 

<script type="application/ld+json">
{
    "@context" : "http://schema.org",
    "@type" : "BlogPosting",
    "mainEntityOfPage": {
         "@type": "WebPage",
         "@id": "https:\/\/xibolun.github.io"
    },
    "articleSection" : "post",
    "name" : "etcd––从源码看raft选举",
    "headline" : "etcd––从源码看raft选举",
    "description" : "Raft算法 分布式一致性算法最出名的是paxos，但是因为其非常难以理解，所以便有了简单可理解的raft算法；Raft将分布式问题归为几个模",
    "inLanguage" : "zh-cn",
    "author" : "pengganyu",
    "creator" : "pengganyu",
    "publisher": "pengganyu",
    "accountablePerson" : "pengganyu",
    "copyrightHolder" : "pengganyu",
    "copyrightYear" : "2020",
    "datePublished": "2020-07-03 15:48:17 \u002b0800 CST",
    "dateModified" : "2020-07-03 15:48:17 \u002b0800 CST",
    "url" : "https:\/\/xibolun.github.io\/post\/etcd\/etcd%E4%BB%8E%E6%BA%90%E7%A0%81%E7%9C%8Braft%E9%80%89%E4%B8%BE\/",
    "wordCount" : "3267",
    "keywords" : [ "etcd", "Peng ganyu blog"]
}
</script>

  </head>
    <body class="">
        <div class="wrapper">
            <nav class="navbar">
    
        <progress class="content_progress" max="0" value="0"></progress>
    
    <div class="container">
        
            <div class="navbar-header header-back2home-logo">
                <span class="logo_mark" >>$</span>
                <a href="https://xibolun.github.io">
                    <span class="logo_text" >cd /home/</span>
                    <span class="logo_cursor" ></span>
                </a>
            </div>
        
        <div class="navbar-right">
                
                <span class="menu">
                
                <a class="menu-item" href="/post/" title="">Blog</a>
                
                <a class="menu-item" href="/tags/tool/" title="">Tools</a>
                
                <a class="menu-item" href="/categories/" title="">Categories</a>
                
                <a class="menu-item" href="/tags/" title="">Tags</a>
                
                <a class="menu-item" href="/books" title="">读书</a>
                
                <a class="menu-item" href="/tags/sre-weekly/" title="">SRE周刊</a>
                
                <a class="menu-item" href="/about/" title="">About</a>
                
                <span class="divide"></span>
                <a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-dark-mode"></i></a>
                </span>
        </div>
    </div>
</nav>
<nav class="navbar-mobile" id="nav-mobile" style="display: none">
    
        <progress class="content_progress" max="0" value="0"></progress>
    
     <div class="container">
        <div class="navbar">
            <div class="navbar-header header-logo">
                    <a href="https://xibolun.github.io">Peng ganyu blog</a>
            </div>
            <div class="navbar-right">
                <div><a href="javascript:void(0);" class="theme-switch"><i class="iconfont icon-dark-mode"></i></a></div>
                <div class="menu-toggle">
                    <span></span><span></span><span></span>
                </div>
            </div>
        </div>
     
          <div class="menu" id="mobile-menu">
                <nav class="mb-md">
                    
                    
                        <a class="menu-item" href="/post/" title="">
                            <h3>Blog</h3>
                            <div class="menu-active"></div>
                        </a>
                    
                        <a class="menu-item" href="/tags/tool/" title="">
                            <h3>Tools</h3>
                            <div class="menu-active"></div>
                        </a>
                    
                        <a class="menu-item" href="/categories/" title="">
                            <h3>Categories</h3>
                            <div class="menu-active"></div>
                        </a>
                    
                        <a class="menu-item" href="/tags/" title="">
                            <h3>Tags</h3>
                            <div class="menu-active"></div>
                        </a>
                    
                        <a class="menu-item" href="/books" title="">
                            <h3>读书</h3>
                            <div class="menu-active"></div>
                        </a>
                    
                        <a class="menu-item" href="/tags/sre-weekly/" title="">
                            <h3>SRE周刊</h3>
                            <div class="menu-active"></div>
                        </a>
                    
                        <a class="menu-item" href="/about/" title="">
                            <h3>About</h3>
                            <div class="menu-active"></div>
                        </a>
                    
                </nav>
        </div>
    </div>
</nav>
            <main class="main">
                <div class="container">
                    
<article class="post-warp" itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
        <h1 class="post-title" itemprop="name headline">etcd––从源码看raft选举</h1>
        <div class="post-meta">
                Written
                <span class="post-time">
                on <time datetime=2020-07-03 itemprop="datePublished">July 3, 2020</time>
                </span>
                in
                
                <i class="iconfont icon-folder"></i>
                <span class="post-category">
                        
                        
                        
                          <a href="https://xibolun.github.io/categories/etcd/"> etcd, </a>
                        
                        
                </span>
                <span class="post-word-count">3267 words</span>
                
                
                <span id="busuanzi_container_page_pv">本文阅读量<span id="busuanzi_value_page_pv"></span>次</span>
        </div>
    </header>

    <div class="post-content">
        

        
        
            
        

        
        
        
        
        

        
        
        

        <h3 id="raft算法">Raft算法</h3>
<p>分布式一致性算法最出名的是<code>paxos</code>，但是因为其非常难以理解，所以便有了简单可理解的<code>raft</code>算法；<code>Raft</code>将分布式问题归为几个模块来解决</p>
<ul>
<li>领袖选举：<code>raft</code>使用非对称节点的方式，必须有一个节点说了算</li>
<li>日志复制：将主节点的日志条目<code>entry</code>同步至其他节点当中，保持一致性</li>
<li>安全性：节点挂了，然后再重启的一些问题场景</li>
<li>成员关系变化 ：当配置发生变化的时候，节点还可以正常执行</li>
</ul>
<p>Raft同时搞了几个角色和名词</p>
<ul>
<li><code>leader</code>：领袖节点，此节点有话语权，通知其他节点强制更新自己的数据条目</li>
<li><code>follwer</code>：群众，老百姓，受<code>leader</code>管控，同时可以发起选举投票；</li>
<li><code>candidate</code>：候选人，每一个<code>follower</code>在选举过程当中都可以成功候选人，若投票成功会变成<code>leader</code></li>
<li><code>term</code>：任期，是一个整数类型的时间，当<code>leader</code>任期到了，就会发起选举；同时每一个节点里面都有最新的<code>term</code>，当<code>leader</code>发送一些信息的时候，可以校验这个<code>leader</code>任期是否到了；</li>
</ul>
<h3 id="选举过程">选举过程</h3>
<h4 id="发起投票">发起投票</h4>
<ul>
<li>当<code>follower</code>的选举定时器时间到了（长时间没有收到<code>leader</code>的消息），就会发起一次投票选举；</li>
</ul>
<p><img src="/img/etcd/etcd-election-tick.jpg" alt="follower tick" loading="lazy" ></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// tickElection is run by followers and candidates after r.electionTimeout.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">raft</span>) <span style="color:#a6e22e">tickElection</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">electionElapsed</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">promotable</span>() <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">pastElectionTimeout</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">electionElapsed</span> = <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 开始发起一次
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Step</span>(<span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Message</span>{<span style="color:#a6e22e">From</span>: <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">Type</span>: <span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">MsgHup</span>})
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>此计时器是一个随机的时间，在每次<code>reset</code>的时候都会启动一个</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">raft</span>) <span style="color:#a6e22e">resetRandomizedElectionTimeout</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">randomizedElectionTimeout</span> = <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">electionTimeout</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">globalRand</span>.<span style="color:#a6e22e">Intn</span>(<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">electionTimeout</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="源节点的变化">源节点的变化</h4>
<ul>
<li>角色修改为<code>candidate</code></li>
<li>重置计数器</li>
</ul>
<p><img src="/img/etcd/etcd-election-candidate.jpg" alt="follower to candidate" loading="lazy" ></p>
<ul>
<li>投票的对象变为自身</li>
<li>开始接收其他节点的信息</li>
</ul>
<p><img src="/img/etcd/etcd-election-vote.jpg" alt="candidate vote" loading="lazy" ></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">raft</span>) <span style="color:#a6e22e">becomeCandidate</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// TODO(xiangli) remove the panic when the raft implementation is stable
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">state</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">StateLeader</span> {
</span></span><span style="display:flex;"><span>		panic(<span style="color:#e6db74">&#34;invalid transition [leader -&gt; candidate]&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// stepCandidate是一个函数，处理消息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">step</span> = <span style="color:#a6e22e">stepCandidate</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">reset</span>(<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Term</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">tick</span> = <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">tickElection</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Vote</span> = <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">id</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// StateCandidate常量
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">state</span> = <span style="color:#a6e22e">StateCandidate</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;%x became candidate at term %d&#34;</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Term</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>campaign函数即为处理每一次选举，投票，追加日志，心跳等所有信息的入口</p>
<h4 id="接收其他节点的消息">接收其他节点的消息</h4>
<p>此逻辑即为上面提到的<code>stepCandidate</code>函数，由于其他节点的消息可能会有多种存在，这些消息都会有类型，根据不同的类型，源节点也会进行不同的操作；</p>
<h5 id="appendentry">AppendEntry</h5>
<p>这个是追加日志的消息，说明外面已经有<code>leader</code>了，源节点自动变为<code>follower</code>，并处理<code>appendEntry</code>，</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">MsgApp</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">becomeFollower</span>(<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Term</span>, <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">From</span>) <span style="color:#75715e">// always m.Term == r.Term
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">handleAppendEntries</span>(<span style="color:#a6e22e">m</span>)
</span></span></code></pre></div><p>变成<code>follower</code>也很简单</p>
<ul>
<li>节点状态修改为<code>follower</code></li>
<li>重置计数器</li>
<li>设置<code>leader</code></li>
<li>设置<code>term</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">raft</span>) <span style="color:#a6e22e">becomeFollower</span>(<span style="color:#a6e22e">term</span> <span style="color:#66d9ef">uint64</span>, <span style="color:#a6e22e">lead</span> <span style="color:#66d9ef">uint64</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 做为一个follower，需要接收消息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">step</span> = <span style="color:#a6e22e">stepFollower</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">reset</span>(<span style="color:#a6e22e">term</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">tick</span> = <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">tickElection</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">lead</span> = <span style="color:#a6e22e">lead</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">state</span> = <span style="color:#a6e22e">StateFollower</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;%x became follower at term %d&#34;</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Term</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>处理<code>entry</code>的逻辑有几个判断</p>
<ul>
<li>因为外面的<code>leader</code>可能是旧的<code>leader</code>，所以需要判断一下它的<code>term</code></li>
<li>有可能<code>follower</code>的日志与<code>leader</code>的日志相关比较远，那就返回一个<code>reject</code>消息，同时将自己最新的<code>logId</code>返回，这样<code>leader</code>就知道这个<code>follower</code>差了多少的日志，再给他发过来，让他强制更新</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">raft</span>) <span style="color:#a6e22e">handleAppendEntries</span>(<span style="color:#a6e22e">m</span> <span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Message</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 是不是最新的日志？
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Index</span> &lt; <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">raftLog</span>.<span style="color:#a6e22e">committed</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">send</span>(<span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Message</span>{<span style="color:#a6e22e">To</span>: <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">From</span>, <span style="color:#a6e22e">Type</span>: <span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">MsgAppResp</span>, <span style="color:#a6e22e">Index</span>: <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">raftLog</span>.<span style="color:#a6e22e">committed</span>})
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 开始追加
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">mlastIndex</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">raftLog</span>.<span style="color:#a6e22e">maybeAppend</span>(<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Index</span>, <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">LogTerm</span>, <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Commit</span>, <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Entries</span><span style="color:#f92672">...</span>); <span style="color:#a6e22e">ok</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">send</span>(<span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Message</span>{<span style="color:#a6e22e">To</span>: <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">From</span>, <span style="color:#a6e22e">Type</span>: <span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">MsgAppResp</span>, <span style="color:#a6e22e">Index</span>: <span style="color:#a6e22e">mlastIndex</span>})
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 日志对不上号，与leader相比少了
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Debugf</span>(<span style="color:#e6db74">&#34;%x [logterm: %d, index: %d] rejected MsgApp [logterm: %d, index: %d] from %x&#34;</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">raftLog</span>.<span style="color:#a6e22e">zeroTermOnErrCompacted</span>(<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">raftLog</span>.<span style="color:#a6e22e">term</span>(<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Index</span>)), <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Index</span>, <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">LogTerm</span>, <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Index</span>, <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">From</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">send</span>(<span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Message</span>{<span style="color:#a6e22e">To</span>: <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">From</span>, <span style="color:#a6e22e">Type</span>: <span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">MsgAppResp</span>, <span style="color:#a6e22e">Index</span>: <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Index</span>, <span style="color:#a6e22e">Reject</span>: <span style="color:#66d9ef">true</span>, <span style="color:#a6e22e">RejectHint</span>: <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">raftLog</span>.<span style="color:#a6e22e">lastIndex</span>()})
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h5 id="heartbeat">heartbeat</h5>
<p>外面的<code>leader</code>来视察，看看<code>follower</code>是否还活着，那节点就需要放弃投票，变成<code>follower</code>，同时执行心跳并返回</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">MsgHeartbeat</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">becomeFollower</span>(<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Term</span>, <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">From</span>) <span style="color:#75715e">// always m.Term == r.Term
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">handleHeartbeat</span>(<span style="color:#a6e22e">m</span>)
</span></span></code></pre></div><h5 id="snapshot">snapshot</h5>
<p>外面的<code>leader</code>来添加快照，那节点就需要放弃投票，变成<code>follower</code>，同时执行快照的逻辑</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">MsgSnap</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">becomeFollower</span>(<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Term</span>, <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">From</span>) <span style="color:#75715e">// always m.Term == r.Term
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">handleSnapshot</span>(<span style="color:#a6e22e">m</span>)
</span></span></code></pre></div><h5 id="vote">vote</h5>
<p>其他节点会发送一个<code>voteResp</code>类型的消息，这个消息里面包含着两个重要属性</p>
<ul>
<li>from：投票来自哪个节点，即对方节点的id</li>
<li>Reject：拒绝消息，取反 !Reject，即投的反对票、支持票；</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>		<span style="color:#a6e22e">gr</span>, <span style="color:#a6e22e">rj</span>, <span style="color:#a6e22e">res</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">poll</span>(<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">From</span>, <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Type</span>, !<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Reject</span>)
</span></span></code></pre></div><p>节点会进行计票</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>func <span style="color:#f92672">(</span>r *raft<span style="color:#f92672">)</span> poll<span style="color:#f92672">(</span>id uint64, t pb.MessageType, v bool<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>granted int, rejected int, result quorum.VoteResult<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> v <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		r.logger.Infof<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;%x received %s from %x at term %d&#34;</span>, r.id, t, id, r.Term<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>		r.logger.Infof<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;%x received %s rejection from %x at term %d&#34;</span>, r.id, t, id, r.Term<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>	r.prs.RecordVote<span style="color:#f92672">(</span>id, v<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> r.prs.TallyVotes<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>若节点所获得的票数大于<code>n/2+1</code>，则表示胜出</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#a6e22e">MajorityConfig</span>) <span style="color:#a6e22e">VoteResult</span>(<span style="color:#a6e22e">votes</span> <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">uint64</span>]<span style="color:#66d9ef">bool</span>) <span style="color:#a6e22e">VoteResult</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">c</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// By convention, the elections on an empty config win. This comes in
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// handy with joint quorums because it&#39;ll make a half-populated joint
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// quorum behave like a majority quorum.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">VoteWon</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">ny</span> <span style="color:#f92672">:=</span> [<span style="color:#ae81ff">2</span>]<span style="color:#66d9ef">int</span>{} <span style="color:#75715e">// vote counts for no and yes, respectively
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">missing</span> <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">id</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">c</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">v</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">votes</span>[<span style="color:#a6e22e">id</span>]
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ok</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">missing</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">v</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">ny</span>[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>		} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">ny</span>[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// n/2+1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">q</span> <span style="color:#f92672">:=</span> len(<span style="color:#a6e22e">c</span>)<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 投票数大于 n/2+1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ny</span>[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">&gt;=</span> <span style="color:#a6e22e">q</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">VoteWon</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 投票数 + 未投票数 大于q，则继续等待那些没有投的票
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ny</span>[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">+</span><span style="color:#a6e22e">missing</span> <span style="color:#f92672">&gt;=</span> <span style="color:#a6e22e">q</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">VotePending</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 投票失败
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">VoteLost</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>若投票成功，则变成<code>leader</code>，失败则变成<code>follower</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>	<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">res</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">quorum</span>.<span style="color:#a6e22e">VoteWon</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 若是预选举，则进行真正的选举，这个在真实的生产环境当中没有使用
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">state</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">StatePreCandidate</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">campaign</span>(<span style="color:#a6e22e">campaignElection</span>)
</span></span><span style="display:flex;"><span>			} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 成为leader
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">becomeLeader</span>()
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 广播一个空的追加日志消息，让其他节点修改自己的term，和leaderId
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">bcastAppend</span>()
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">quorum</span>.<span style="color:#a6e22e">VoteLost</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// pb.MsgPreVoteResp contains future term of pre-candidate
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#75715e">// m.Term &gt; r.Term; reuse r.Term
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">becomeFollower</span>(<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Term</span>, <span style="color:#a6e22e">None</span>)
</span></span><span style="display:flex;"><span>		}
</span></span></code></pre></div><h4 id="成为leader">成为leader</h4>
<p><img src="/img/etcd/etcd-election-become-leader.jpg" alt="candidate to leader" loading="lazy" ></p>
<p>成为leader即为<code>becomseLeader</code>，做了如下的操作</p>
<ul>
<li>开始做为<code>leader</code>的<code>step</code>，这里主要是做几个事情：
<ul>
<li>心跳：看看其他的<code>follower</code>是否还活着</li>
<li>校验<code>quorum</code>（法人）即自己是否一直持有最高的投票数</li>
<li>接受<code>proposal</code>（提案）：即是否同步日志<code>entry</code>给其他的节点</li>
<li>获取当前最新的日志<code>index</code>：当前<code>leader</code>的<code>raftlog</code>的<code>lastIndex</code></li>
</ul>
</li>
<li>设置<code>Term</code></li>
<li>将<code>tick</code>修改为心跳的<code>tick</code>，之前是<code>tickElection</code></li>
<li>设置状态为<code>Leaader</code></li>
<li>生与一个空日志，尝试一下是否可以追加，主要是想办法一下，现在的<code>uncommittedSize</code>是否够用；默认配置的上限为<code>1G</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">raft</span>) <span style="color:#a6e22e">becomeLeader</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 这里还有李响的一个TODO，也不知道什么时候会实现，哈哈
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// TODO(xiangli) remove the panic when the raft implementation is stable
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">state</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">StateFollower</span> {
</span></span><span style="display:flex;"><span>		panic(<span style="color:#e6db74">&#34;invalid transition [follower -&gt; leader]&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">step</span> = <span style="color:#a6e22e">stepLeader</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">reset</span>(<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Term</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">tick</span> = <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">tickHeartbeat</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">lead</span> = <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">id</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">state</span> = <span style="color:#a6e22e">StateLeader</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">prs</span>.<span style="color:#a6e22e">Progress</span>[<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">id</span>].<span style="color:#a6e22e">BecomeReplicate</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">pendingConfIndex</span> = <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">raftLog</span>.<span style="color:#a6e22e">lastIndex</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">emptyEnt</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Entry</span>{<span style="color:#a6e22e">Data</span>: <span style="color:#66d9ef">nil</span>}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">appendEntry</span>(<span style="color:#a6e22e">emptyEnt</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// This won&#39;t happen because we just called reset() above.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Panic</span>(<span style="color:#e6db74">&#34;empty entry was dropped&#34;</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">reduceUncommittedSize</span>([]<span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Entry</span>{<span style="color:#a6e22e">emptyEnt</span>})
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;%x became leader at term %d&#34;</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Term</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>	<span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">raft</span>.<span style="color:#a6e22e">Config</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">ID</span>:                        uint64(<span style="color:#a6e22e">rc</span>.<span style="color:#a6e22e">id</span>),
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">ElectionTick</span>:              <span style="color:#ae81ff">10</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">HeartbeatTick</span>:             <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Storage</span>:                   <span style="color:#a6e22e">rc</span>.<span style="color:#a6e22e">raftStorage</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">MaxSizePerMsg</span>:             <span style="color:#ae81ff">1024</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1024</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">MaxInflightMsgs</span>:           <span style="color:#ae81ff">256</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 默认unCommitted大小为 2^30=1G
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">MaxUncommittedEntriesSize</span>: <span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">30</span>,
</span></span><span style="display:flex;"><span>	}
</span></span></code></pre></div><h3 id="几个问题">几个问题</h3>
<h4 id="选举不出来怎么办">选举不出来怎么办？</h4>
<p>活着的<code>follower</code>不足，导致大家计票数都一样；比如3个节点，挂了一个，其他两个节点各得一票，无法胜出，怎么办呢？这个时候就会走超时逻辑，然后每个<code>follower</code>的选举随机计时器触发即可；</p>
<h4 id="其他节点什么时候投反对支持">其他节点什么时候投反对、支持？</h4>
<ul>
<li>
<p>其他节点什么时候投支持、什么时候投反对呢？当节点接收到一个类型为<code>msgVote</code>消息的时候，这个里面有几个重要的属性</p>
<ul>
<li>
<p>from：消息来源，即发起投票的节点id</p>
</li>
<li>
<p>term：发起节点的term</p>
</li>
<li>
<p>logTerm：发起节点发起投票前的term</p>
</li>
<li>
<p>index: 发起节点log的index</p>
</li>
</ul>
</li>
<li>
<p>投票逻辑如下：</p>
<ul>
<li>
<p>校验自己是否具备投票的资格，几种情况可以投票：</p>
<ul>
<li>已经投过此节点，咱可以再投</li>
</ul>
</li>
<li>
<p>节点是没有投过票、节点没有<code>leader</code>，</p>
<ul>
<li>节点所记录的<code>term</code>比消息来源节点的短；</li>
</ul>
</li>
<li>
<p>若不满足上面的条件，就投反对票</p>
</li>
<li>
<p>若满足，则拿发起节点的历史term和logIndex进行比对，若本地的比发起节点的超前，那就投反对票（如节点down了很久，重新发起投票，日志已经很久没有更新）；若比投票节点老，则人他一票吧；</p>
</li>
</ul>
</li>
<li>
<p>不管投支持、反对票，都会将本地的投票计时器清0</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">case</span> <span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">MsgVote</span>, <span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">MsgPreVote</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// We can vote if this is a repeat of a vote we&#39;ve already cast...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">canVote</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Vote</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">From</span> <span style="color:#f92672">||</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// ...we haven&#39;t voted and we don&#39;t think there&#39;s a leader yet in this term...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			(<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Vote</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">None</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">lead</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">None</span>) <span style="color:#f92672">||</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// ...or this is a PreVote for a future term...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			(<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Type</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">MsgPreVote</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Term</span> &gt; <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Term</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// ...and we believe the candidate is up to date.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// 校验一下是不是最新的，
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">canVote</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">raftLog</span>.<span style="color:#a6e22e">isUpToDate</span>(<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Index</span>, <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">LogTerm</span>) {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">send</span>(<span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Message</span>{<span style="color:#a6e22e">To</span>: <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">From</span>, <span style="color:#a6e22e">Term</span>: <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Term</span>, <span style="color:#a6e22e">Type</span>: <span style="color:#a6e22e">voteRespMsgType</span>(<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Type</span>)})
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Type</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">MsgVote</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#75715e">// Only record real votes.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">electionElapsed</span> = <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Vote</span> = <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">From</span>
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;%x [logterm: %d, index: %d, vote: %x] rejected %s from %x [logterm: %d, index: %d] at term %d&#34;</span>,
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">raftLog</span>.<span style="color:#a6e22e">lastTerm</span>(), <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">raftLog</span>.<span style="color:#a6e22e">lastIndex</span>(), <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Vote</span>, <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Type</span>, <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">From</span>, <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">LogTerm</span>, <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Index</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Term</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">send</span>(<span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Message</span>{<span style="color:#a6e22e">To</span>: <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">From</span>, <span style="color:#a6e22e">Term</span>: <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Term</span>, <span style="color:#a6e22e">Type</span>: <span style="color:#a6e22e">voteRespMsgType</span>(<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Type</span>), <span style="color:#a6e22e">Reject</span>: <span style="color:#66d9ef">true</span>})
</span></span><span style="display:flex;"><span>		}
</span></span></code></pre></div><h4 id="如何控制节点不发起投票">如何控制节点不发起投票</h4>
<p><img src="/img/etcd/etcd-election-heartbeat.jpg" alt="leader heartbeat" loading="lazy" ></p>
<p><code>leader</code>会向每个<code>follower</code>发一个心跳，每发一次就会将<code>follower</code>的投票计时器清0</p>
<h4 id="来了新加节点怎么办">来了新加节点怎么办？</h4>
<p>新加的节点默认是<code>follower</code>，此时它没有<code>leader</code>，<code>term</code>也会0，这时候会有两种情况</p>
<ul>
<li>若在投票计时器没有到点的时候，收到<code>leader</code>的心跳消息，则更新<code>leader</code>和<code>term</code>信息；</li>
<li>若投票计时器到点了，那此时就会发起投票；<code>leader</code>会收到一个投票的消息，一看<code>term</code>和<code>index</code>都不是最新的，直接投否定票，即发一个<code>reject</code>消息给它，然后心跳时间到了，再发一个心跳给它，前面防止它从<code>candidate</code>成为<code>leader</code>，后者直接将其从<code>candidate</code>变为<code>follower</code></li>
</ul>
<h4 id="leader挂了怎么办">leader挂了怎么办？</h4>
<p><code>leader</code>挂了，就不会再有心跳，<code>follower</code>进入选举过程；</p>
<p><img src="/img/etcd/etcd-election-leader-down.jpg" alt="leader down" loading="lazy" ></p>
<h3 id="参考">参考</h3>
<ul>
<li><a href="http://thesecretlivesofdata.com/raft/">在线理解raft</a></li>
</ul>

    </div>

    <div class="post-copyright">
            
            <p class="copyright-item">
                <span>Author:</span>
                <span>pengganyu </span>
                </p>
            

            
            <p class="copyright-item">
                    <span>Link:</span>
                    <a href=https://xibolun.github.io/post/etcd/etcd%E4%BB%8E%E6%BA%90%E7%A0%81%E7%9C%8Braft%E9%80%89%E4%B8%BE/>https://xibolun.github.io/post/etcd/etcd%E4%BB%8E%E6%BA%90%E7%A0%81%E7%9C%8Braft%E9%80%89%E4%B8%BE/</span>
            </p>
            
            
    </div>


    <div class="post-tags">
        
            <section>
            <i class="iconfont icon-tag"></i>Tag(s):
            
            <span class="tag"><a href="https://xibolun.github.io/tags/etcd/">
                    #etcd</a></span>
            
            </section>
        
        <section>
                <a href="javascript:window.history.back();">back</a></span> ·
                <span><a href="https://xibolun.github.io">home</a></span>
        </section>
    </div>

    <div class="post-nav">
        
        <a href="https://xibolun.github.io/post/etcd/etcd%E5%85%A5%E9%97%A8/" class="prev" rel="prev" title="etcd––入门"><i class="iconfont icon-left"></i>&nbsp;etcd––入门</a>
        
        
        <a href="https://xibolun.github.io/post/etcd/etcd%E4%BB%8E%E6%BA%90%E7%A0%81%E7%9C%8B%E6%97%A5%E5%BF%97%E5%A4%8D%E5%88%B6/" class="next" rel="next" title="etcd––从源码看日志复制">etcd––从源码看日志复制&nbsp;<i class="iconfont icon-right"></i></a>
        
    </div>

    <div class="post-comment">
        
            
                <div id="utteranc-container">
    <script src='https://utteranc.es/client.js'
        repo='xibolun/xibolun.github.io'
        issue-term='title'
        theme='github-light'
        crossorigin='anonymous'
        async>
    </script>
</div>
            
        
    </div>
</article>
                </div>
            </main>
            <footer class="footer">
  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2016 - 2025</span>
    
    <span class="with-love">
      <i class="iconfont icon-love"></i>
    </span>
    
    <span class="author" itemprop="copyrightHolder"
      ><a href="https://xibolun.github.io">pengganyu</a> |
    </span>
     

    <span
      >Powered by
      <a href="https://gohugo.io/" target="_blank" rel="external nofollow"
        >Hugo</a
      >
      
      
      <span id="busuanzi_container_site_pv">
        本站总访问量<span id="busuanzi_value_site_pv"></span>次
      </span>
      <span id="busuanzi_container_site_uv">
        本站访客数<span id="busuanzi_value_site_uv"></span>人次
      </span></span
    >
  </div>
</footer>






<script defer src="/js/vendor_main.min.js"></script>







<script src="https://cdn.jsdelivr.net/npm/pangu@4.0.7/dist/browser/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script>
<script> pangu.spacingPage();</script>





        </div>
    </body>
</html>
